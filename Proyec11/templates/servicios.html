{% extends "base.html" %}

{% block title %}Servicios - BoodFood{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>Nuestros Servicios</h1>
        <p>Disfruta de experiencias √∫nicas en BoodFood</p>
    </div>
</div>

<div class="servicios-container">
    <div class="container">
        <div class="servicios-intro">
            <p>En BoodFood ofrecemos mucho m√°s que comida deliciosa...</p>
        </div>
        
        <div class="servicios-grid">
            {% for servicio in servicios %}
            <div class="servicio-card servicio-{{ servicio.tipo }}">
                <div class="servicio-icono">
                    {% if servicio.tipo == 'piscina' %}üèä
                    {% elif servicio.tipo == 'billar' %}üé±
                    {% elif servicio.tipo == 'evento' %}üéâ
                    {% else %}‚≠ê{% endif %}
                </div>
                <div class="servicio-contenido">
                    <h3>{{ servicio.nombre }}</h3>
                    <p class="servicio-descripcion">{{ servicio.descripcion }}</p>
                    <div class="servicio-detalles">
                        {% if servicio.capacidad %}
                        <div class="servicio-detalle"><strong>Capacidad:</strong> {{ servicio.capacidad }} personas</div>
                        {% endif %}
                        <div class="servicio-precio"><strong>Precio:</strong> ${{ "{:,.0f}".format(servicio.precio) }}</div>
                    </div>
                    <button class="btn btn-primary" onclick="reservarServicio({{ servicio.id }}, '{{ servicio.nombre|e }}', {{ servicio.precio }}, '{{ servicio.tipo }}')">
                        Reservar Ahora
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Secciones destacadas (piscina, entretenimiento, eventos) -->
        <!-- ... (mant√©n tu HTML existente aqu√≠) ... -->
        
    </div>
</div>

<!-- ‚úÖ Incluir los modales parciales -->
{% include '_modales/_modal_billar.html' %}
{% include '_modales/_modal_evento.html' %}
{% include '_modales/_modal_piscina.html' %}
{% include '_modales/_modal_pedidos_piscina.html' %}

<script>
// Guardar precios de servicios en variable global
window.preciosServicios = window.preciosServicios || {};

function reservarServicio(id, nombre, precio, tipo) {
    const isAuth = {{ 'true' if current_user.is_authenticated else 'false' }};
    if (!isAuth) {
        if (confirm('Debes iniciar sesi√≥n para reservar servicios.\n¬øDeseas ir a la p√°gina de inicio de sesi√≥n?')) {
            window.location.href = '/auth/login?next={{ url_for("main.servicios") }}';
        }
        return;
    }

    // Guardar precio del servicio
    window.preciosServicios[tipo] = precio;
    
    // Establecer fecha m√≠nima (hoy)
    const hoy = new Date().toISOString().split('T')[0];

    if (tipo === 'billar') {
        document.getElementById('servicio_id_billar').value = id;
        document.getElementById('titulo-servicio-billar').textContent = nombre;
        document.getElementById('fecha_billar').min = hoy;
        document.getElementById('modal-reserva-billar').style.display = 'flex';
        actualizarTotalBillar();
        // Listeners para recalcular en cambio
        document.getElementById('duracion_billar').oninput = actualizarTotalBillar;
    }
    else if (tipo === 'evento') {
        document.getElementById('servicio_id_evento').value = id;
        document.getElementById('titulo-servicio-evento').textContent = nombre;
        document.getElementById('fecha_evento').min = hoy;
        document.getElementById('modal-reserva-evento').style.display = 'flex';
        actualizarTotalEvento();
        // Listeners para recalcular en cambio
        document.getElementById('personas_evento').oninput = actualizarTotalEvento;
    }
    else if (tipo === 'piscina') {
        document.getElementById('servicio_id_piscina').value = id;
        document.getElementById('titulo-servicio-piscina').textContent = nombre;
        document.getElementById('fecha_piscina').min = hoy;
        document.getElementById('modal-reserva-piscina').style.display = 'flex';
        actualizarTotalPiscina();
        // Listeners para recalcular en cambio
        document.getElementById('personas_piscina').oninput = actualizarTotalPiscina;
        document.getElementById('incluye_toallas').onchange = actualizarTotalPiscina;
    }
    else {
        if (confirm(`¬øDeseas reservar ${nombre} por $${precio.toLocaleString()}?`)) {
            window.location.href = '/reservas?servicio=' + id;
        }
    }
}

function actualizarTotalBillar() {
	const precioPorHora = 15000; // $15.000 por hora
	const horas = parseInt(document.getElementById('duracion_billar').value) || 2;
	const total = precioPorHora * horas;
	document.getElementById('total_billar').textContent = total.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });
}

function actualizarTotalEvento() {
    const precio = window.preciosServicios['evento'] || 0;
    const personas = parseInt(document.getElementById('personas_evento').value) || 0;
    
    // Validaci√≥n de capacidad m√°xima
    const inputPersonas = document.getElementById('personas_evento');
    if (personas > 200) {
        inputPersonas.value = 200;
    }
    
    // Total fijo, NO multiplicar por personas
    let total = precio;
    
    // Descuento por grupo grande: >50 invitados = 10% descuento
    let descuentoTexto = '';
    if (personas > 50) {
        const descuento = total * 0.10;
        total = total - descuento;
        descuentoTexto = ` <small style="color: #28a745;">(10% descuento aplicado)</small>`;
    }
    
    document.getElementById('total_evento').innerHTML = total.toLocaleString('es-CO', { style: 'currency', currency: 'COP' }) + descuentoTexto;
}

function actualizarTotalPiscina() {
	const precioPorPersona = 10000; // $10.000 por persona
	const personas = parseInt(document.getElementById('personas_piscina').value) || 2;
	const includeToallas = document.getElementById('incluye_toallas')?.checked || false;
	
	// Validaci√≥n de capacidad m√°xima
	const inputPersonas = document.getElementById('personas_piscina');
	if (personas > 50) {
		inputPersonas.value = 50;
	}
	
	let total = precioPorPersona * personas;
	
	// Agregar costo de toallas si est√° marcado
	if (includeToallas) {
		total += 5000 * personas; // $5.000 adicional por persona con toalla
	}
	
	// Descuento por grupos grandes: >10 personas = 15% descuento
	let descuentoTexto = '';
	if (personas > 10) {
		const descuento = total * 0.15;
		total = total - descuento;
		descuentoTexto = ` <small style="color: #28a745;">(15% descuento grupal)</small>`;
	}
	
	document.getElementById('total_piscina').innerHTML = total.toLocaleString('es-CO', { style: 'currency', currency: 'COP' }) + descuentoTexto;
}

function cerrarModal(id) {
    document.getElementById(id).style.display = 'none';
}

window.onclick = function(event) {
    const modales = ['modal-reserva-billar', 'modal-reserva-evento', 'modal-reserva-piscina'];
    modales.forEach(id => {
        const modal = document.getElementById(id);
        if (modal && event.target === modal) {
            cerrarModal(id);
        }
    });
}

// Enviar reservas de servicios por AJAX para evitar navegar fuera de la p√°gina
async function enviarReservaServicio(e, tipo) {
    e.preventDefault();
    
    // Validar fecha y hora
    const fechaInput = document.getElementById(`fecha_${tipo}`);
    const horaInput = document.getElementById(`hora_${tipo}`);
    const personasInput = document.getElementById(`personas_${tipo}`);
    
    if (!fechaInput.value || !horaInput.value || !personasInput.value) {
        alert('Por favor completa todos los campos obligatorios');
        return false;
    }
    
    // Validar que la fecha no sea en el pasado
    const fechaSeleccionada = new Date(fechaInput.value + 'T' + horaInput.value);
    const ahora = new Date();
    if (fechaSeleccionada < ahora) {
        alert('No puedes reservar en una fecha u hora pasada');
        fechaInput.focus();
        return false;
    }
    
    // Validar n√∫mero de personas seg√∫n el tipo
    const personas = parseInt(personasInput.value);
    if (tipo === 'piscina' && personas > 50) {
        alert('La capacidad m√°xima de la piscina es de 50 personas');
        personasInput.value = 50;
        return false;
    }
    if (tipo === 'evento' && personas > 200) {
        alert('La capacidad m√°xima para eventos es de 200 personas');
        personasInput.value = 200;
        return false;
    }
    
    // Deshabilitar bot√≥n para evitar doble env√≠o
    const btnSubmit = e.target.querySelector('button[type="submit"]');
    const textoOriginal = btnSubmit.textContent;
    btnSubmit.disabled = true;
    btnSubmit.textContent = 'Procesando...';
    
    try {
        let payload = { tipo };
        if (tipo === 'billar') {
            payload.servicio_id = document.getElementById('servicio_id_billar').value;
            payload.fecha = document.getElementById('fecha_billar').value;
            payload.hora = document.getElementById('hora_billar').value;
            payload.numero_personas = document.getElementById('personas_billar').value;
            payload.mesa_id = document.getElementById('mesa_billar').value;
        } else if (tipo === 'evento') {
            payload.servicio_id = document.getElementById('servicio_id_evento').value;
            payload.fecha = document.getElementById('fecha_evento').value;
            payload.hora = document.getElementById('hora_evento').value;
            payload.numero_personas = document.getElementById('personas_evento').value;
            payload.detalles = {
                tipo_evento: document.getElementById('tipo_evento').value,
                notas: document.getElementById('notas_evento').value,
            };
        } else if (tipo === 'piscina') {
            const duracion = parseInt(document.getElementById('duracion_piscina').value);
            if (duracion < 1 || duracion > 8) {
                alert('La duraci√≥n debe ser entre 1 y 8 horas');
                btnSubmit.disabled = false;
                btnSubmit.textContent = textoOriginal;
                return false;
            }
            
            payload.servicio_id = document.getElementById('servicio_id_piscina').value;
            payload.fecha = document.getElementById('fecha_piscina').value;
            payload.hora = document.getElementById('hora_piscina').value;
            payload.numero_personas = document.getElementById('personas_piscina').value;
            payload.detalles = {
                duracion_horas: duracion,
                area_ninos: document.getElementById('ninos_piscina').checked ? 'si' : 'no',
            };
            payload.duracion_estimada = duracion;
        }

        const res = await fetch('/api/reservas/crear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const data = await res.json();
        
        if (!res.ok || data.error) {
            throw new Error(data.error || 'Error al crear la reserva');
        }

        // Mensaje de √©xito con detalles
        const nombreServicio = document.getElementById(`titulo-servicio-${tipo}`).textContent;
        const total = document.getElementById(`total_${tipo}`).textContent;
        alert(`‚úÖ ¬°Reserva confirmada!\n\nServicio: ${nombreServicio}\nFecha: ${payload.fecha}\nHora: ${payload.hora}\nPersonas: ${payload.numero_personas}\nTotal: ${total}\n\nPuedes ver tu reserva en "Mi Cuenta"`);
        
        // Cerrar el modal correspondiente
        cerrarModal(`modal-reserva-${tipo}`);
        
        // Limpiar formulario
        e.target.reset();
        
        // Opcional: redirigir a Mi Cuenta
        // window.location.href = '/cuenta/mi-cuenta';
        
        return false;
    } catch (err) {
        alert('‚ùå Error al crear la reserva:\n' + err.message);
        return false;
    } finally {
        // Rehabilitar bot√≥n
        btnSubmit.disabled = false;
        btnSubmit.textContent = textoOriginal;
    }
}

// ====================
// SISTEMA DE PEDIDOS A LA PISCINA
// ====================

let carritoPiscina = [];

// Funci√≥n para abrir modal de pedidos
async function abrirPedidosPiscina() {
	const isAuth = {{ 'true' if current_user.is_authenticated else 'false' }};
	if (!isAuth) {
		if (confirm('Debes iniciar sesi√≥n para hacer pedidos.\n¬øDeseas ir a la p√°gina de inicio de sesi√≥n?')) {
			window.location.href = '/auth/login?next={{ url_for("main.servicios") }}';
		}
		return;
	}

	// Abrir modal
	document.getElementById('modal-pedidos-piscina').style.display = 'flex';
	
	// Cargar productos
	await cargarProductosPiscina();
}

// Cargar productos disponibles para piscina desde productos_de_consumo_rapido
async function cargarProductosPiscina() {
    const container = document.getElementById('productos-piscina-container');
    
    try {
        const res = await fetch('/api/piscina/productos');
        const data = await res.json();
        
        if (!res.ok) throw new Error('Error al cargar productos');

        const productosPiscina = (Array.isArray(data) ? data : []).filter(p => p && (p.disponible ?? true));

        if (productosPiscina.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No hay productos disponibles para pedidos a la piscina.</p>';
            return;
        }
        
        // Renderizar productos
        container.innerHTML = productosPiscina.map(p => {
            const precio = typeof p.precio === 'number' ? p.precio : parseFloat(p.precio || 0);
            const nombre = (p.nombre || '').toString();
            const descripcion = (p.descripcion || '').toString();
            const idParaPedido = (p.menu_item_id ?? p.id);
            return `
            <div class="producto-piscina-card" data-id="${p.id}">
                <div class="producto-piscina-info">
                    <h4>${nombre}</h4>
                    <p>${descripcion}</p>
                    <span class="producto-piscina-precio">$${(precio||0).toLocaleString('es-CO')}</span>
                </div>
                <div class="producto-piscina-actions">
                    <button class="btn-agregar-piscina" onclick="agregarProductoPiscina(${idParaPedido}, '${nombre.replace(/'/g, "\\'")}', ${precio||0})">
                        + Agregar
                    </button>
                </div>
            </div>`;
        }).join('');
        
    } catch (err) {
        console.error('Error:', err);
        container.innerHTML = '<p style="text-align:center; padding:20px; color:red;">Error al cargar productos. Intenta de nuevo.</p>';
    }
}

// Agregar producto al carrito de piscina
function agregarProductoPiscina(id, nombre, precio) {
	const existe = carritoPiscina.find(item => item.id === id);
	
	if (existe) {
		existe.cantidad++;
	} else {
		carritoPiscina.push({ id, nombre, precio, cantidad: 1 });
	}
	
	actualizarCarritoPiscina();
}

// Actualizar vista del carrito
function actualizarCarritoPiscina() {
	const resumen = document.getElementById('carrito-piscina-resumen');
	const itemsContainer = document.getElementById('carrito-piscina-items');
	const totalSpan = document.getElementById('carrito-piscina-total');
	const btnConfirmar = document.getElementById('btn-confirmar-pedido-piscina');
	
	if (carritoPiscina.length === 0) {
		resumen.style.display = 'none';
		btnConfirmar.disabled = true;
		return;
	}
	
	resumen.style.display = 'block';
	btnConfirmar.disabled = false;
	
	// Renderizar items
	itemsContainer.innerHTML = carritoPiscina.map(item => `
		<div class="carrito-item-piscina">
			<div>
				<strong>${item.nombre}</strong><br>
				<small>$${item.precio.toLocaleString('es-CO')} c/u</small>
			</div>
			<div class="cantidad-controls">
				<button onclick="cambiarCantidadPiscina(${item.id}, -1)">-</button>
				<span>${item.cantidad}</span>
				<button onclick="cambiarCantidadPiscina(${item.id}, 1)">+</button>
				<button onclick="eliminarProductoPiscina(${item.id})" style="background:#f44336; color:white; margin-left:8px;">üóëÔ∏è</button>
			</div>
		</div>
	`).join('');
	
	// Calcular total
	const total = carritoPiscina.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
	totalSpan.textContent = total.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });
}

// Cambiar cantidad de un producto
function cambiarCantidadPiscina(id, delta) {
	const item = carritoPiscina.find(i => i.id === id);
	if (!item) return;
	
	item.cantidad += delta;
	
	if (item.cantidad <= 0) {
		eliminarProductoPiscina(id);
	} else {
		actualizarCarritoPiscina();
	}
}

// Eliminar producto del carrito
function eliminarProductoPiscina(id) {
	carritoPiscina = carritoPiscina.filter(item => item.id !== id);
	actualizarCarritoPiscina();
}

// Confirmar pedido a la piscina
document.getElementById('btn-confirmar-pedido-piscina').addEventListener('click', async function() {
	if (carritoPiscina.length === 0) {
		alert('El carrito est√° vac√≠o');
		return;
	}
	
	const btnConfirmar = this;
	const textoOriginal = btnConfirmar.textContent;
	btnConfirmar.disabled = true;
	btnConfirmar.textContent = '‚è≥ Procesando...';
	
	try {
		// Preparar datos del pedido
		const pedido = {
			tipo: 'piscina',
			items: carritoPiscina.map(item => ({
				id: item.id,
				nombre: item.nombre,
				cantidad: item.cantidad,
				precio: item.precio
			})),
			metodo_pago: 'efectivo',
			instrucciones_entrega: 'PEDIDO PARA LA PISCINA - Entregar en √°rea de piscina'
		};
		
		// Enviar pedido
		const res = await fetch('/pedidos/crear', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(pedido)
		});
		
		const data = await res.json();
		
		if (!res.ok || data.error) {
			throw new Error(data.error || 'Error al crear el pedido');
		}
		
		// √âxito
		const total = carritoPiscina.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
		alert(`‚úÖ ¬°Pedido confirmado!\n\nC√≥digo: ${data.codigo}\nTotal: $${total.toLocaleString('es-CO')}\n\nTu pedido llegar√° a la piscina pronto.`);
		
		// Limpiar carrito y cerrar modal
		carritoPiscina = [];
		actualizarCarritoPiscina();
		cerrarModal('modal-pedidos-piscina');
		
	} catch (err) {
		console.error('Error:', err);
		alert('‚ùå Error al crear el pedido:\n' + err.message);
	} finally {
		btnConfirmar.disabled = false;
		btnConfirmar.textContent = textoOriginal;
	}
});

</script>

<style>
/* ====================== */
/* ‚úÖ ESTILOS ORIGINALES (NO TOCAR) */
/* ====================== */

.servicios-container {
    padding: 3rem 0;
    background-color: var(--light-color);
}

.servicios-intro {
    text-align: center;
    max-width: 800px;
    margin: 0 auto 3rem;
    font-size: 1.1rem;
    color: #666;
}

.servicios-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.servicio-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s;
    text-align: center;
}

.servicio-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.servicio-icono {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.servicio-contenido h3 {
    color: var(--dark-color);
    margin-bottom: 1rem;
}

.servicio-descripcion {
    color: #666;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.servicio-detalles {
    background: var(--light-color);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

.servicio-detalle {
    margin-bottom: 0.5rem;
}

.servicio-precio {
    font-size: 1.3rem;
    color: var(--primary-color);
}

.seccion-destacada {
    background: white;
    border-radius: 15px;
    padding: 3rem;
    margin-bottom: 2rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.seccion-contenido h2 {
    text-align: center;
    margin-bottom: 1rem;
    color: var(--dark-color);
}

.seccion-contenido > p {
    text-align: center;
    max-width: 800px;
    margin: 0 auto 2rem;
    color: #666;
    font-size: 1.1rem;
}

.caracteristicas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.caracteristica {
    text-align: center;
    padding: 1.5rem;
}

.caracteristica-icono {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.caracteristica h4 {
    color: var(--dark-color);
    margin-bottom: 0.5rem;
}

.caracteristica p {
    color: #666;
}

.juegos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.juego-card {
    background: var(--light-color);
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s;
}

.juego-card:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

.juego-imagen {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.juego-card h4 {
    margin-bottom: 0.5rem;
}

.eventos-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
}

.evento-tipo {
    background: var(--light-color);
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
}

.evento-tipo h4 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.eventos-contacto {
    background: var(--primary-color);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    text-align: center;
    margin-top: 2rem;
}

.eventos-contacto p {
    margin: 0.5rem 0;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .servicios-grid,
    .caracteristicas-grid,
    .juegos-grid,
    .eventos-info {
        grid-template-columns: 1fr;
    }
    
    .seccion-destacada {
        padding: 2rem 1rem;
    }
}

/* ====================== */
/* ‚úÖ ESTILOS AISLADOS PARA MODALES */
/* ====================== */

/* Solo afecta a los modales de reserva */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 2rem;
    cursor: pointer;
    color: #999;
}

.close-modal:hover {
    color: #333;
}

/* Estilos espec√≠ficos dentro de los modales */
.modal-content .form-group {
    margin-bottom: 1.2rem;
}

.modal-content .form-group label {
    display: block;
    margin-bottom: 0.4rem;
    font-weight: bold;
    color: #333;
}

.modal-content .form-group input,
.modal-content .form-group select,
.modal-content .form-group textarea {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 1rem;
    box-sizing: border-box;
}

.modal-content .btn {
    padding: 0.7rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    margin-right: 0.5rem;
}

.modal-content .btn-success {
    background-color: #28a745;
    color: white;
}

.modal-content .btn-success:hover {
    background-color: #218838;
}

.modal-content .btn-primary {
    background-color: #007bff;
    color: white;
}

.modal-content .btn-primary:hover {
    background-color: #0056b3;
}

.modal-content .btn-secondary {
    background-color: #6c757d;
    color: white;
}

.modal-content .btn-secondary:hover {
    background-color: #5a6268;
}

/* ‚úÖ Tus estilos existentes aqu√≠ abajo (servicios-container, etc.) */
.servicios-container { /* ... */ }
/* ... (todo tu CSS anterior) ... */
</style>

{% endblock %}